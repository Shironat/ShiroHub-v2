--chmar Services
local S = loadstring(game:HttpGet(
    "https://raw.githubusercontent.com/Shironat/ShiroHub-v2/main/Shared/Services.lua"
))()

local States = loadstring(game:HttpGet(
    "https://raw.githubusercontent.com/Shironat/ShiroHub-v2/main/Shared/States.lua"
))()

local ExploitsLogic = {}

--Services
local Players = S.Players
local RunService = S.RunService
local UIS = S.UIS
local VirtualUser = S.VirtualUser
local TeleportService = S.TeleportService
local Teams = S.Teams
local player = Players.LocalPlayer

--player utils
local function getChar()
    return player.Character or player.CharacterAdded:Wait()
end

local function getHumanoid()
    return getChar():WaitForChild("Humanoid")
end

local function getHRP()
    return getChar():WaitForChild("HumanoidRootPart")
end

--Criar logica
function ExploitsLogic.Reset()
    local hum = getHumanoid()
    hum.Health = 0
end

function ExploitsLogic.Rejoin()
    TeleportService:Teleport(game.PlaceId, player)
end

--   ESP
local espCache = {}

local function createESP(char)
    if espCache[char] then return end
    local highlight = Instance.new("Highlight")
    highlight.FillColor=Color3.fromRGB(255,80,80)
    highlight.OutlineColor=Color3.fromRGB(255,255,255)
    highlight.FillTransparency=0.5
    highlight.OutlineTransparency=0
    highlight.DepthMode=Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Adornee=char
    highlight.Parent=char
    espCache[char]=highlight
end

local function removeESP(char)
    if espCache[char] then
        espCache[char]:Destroy()
        espCache[char]=nil
    end
end

local function isEnemy(plr)
    if plr==player then return false end
    if #Teams:GetTeams()>0 then
        if not player.Team or not plr.Team then return true end
        return plr.Team~=player.Team
    end
    return true
end

function ExploitsLogic.ToggleESP(state)
    States.ESP_ENABLED=state
    if not state then
        for char in pairs(espCache) do removeESP(char) end
    end
end

RunService.RenderStepped:Connect(function()
    if not States.ESP_ENABLED then return end
    local myChar=getChar()
    local myHRP=myChar and myChar:FindFirstChild("HumanoidRootPart")
    if not myHRP then return end

    for _,plr in ipairs(Players:GetPlayers()) do
        if plr~=player and plr.Character then
            local char=plr.Character
            local hrp=char:FindFirstChild("HumanoidRootPart")
            local hum=char:FindFirstChildOfClass("Humanoid")
            if char and hrp and hum and hum.Health>0 and isEnemy(plr) then
                local dist=(myHRP.Position-hrp.Position).Magnitude
                if dist<=States.MAX_DISTANCE then
                    createESP(char)
                else
                    removeESP(char)
                end
            else
                removeESP(char)
            end
        end
    end
end)

-- Limpeza ao sair
Players.PlayerRemoving:Connect(function(plr)
    if plr.Character then removeESP(plr.Character) end
end)


--WalkSpeed
local originalSpeed

function ExploitsLogic.ToggleSpeed(state)
    States.speedEnabled = state
    local hum = getHumanoid()

    if state then
        originalSpeed = originalSpeed or hum.WalkSpeed
        hum.WalkSpeed = originalSpeed * 2
    else
        if originalSpeed then
            hum.WalkSpeed = originalSpeed
            originalSpeed = nil
        end
    end
end

--JumpPower
local originalJump

local function getJump(h)
    return h.UseJumpPower and h.JumpPower or h.JumpHeight
end

local function setJump(h, v)
    if h.UseJumpPower then
        h.JumpPower = v
    else
        h.JumpHeight = v
    end
end

function ExploitsLogic.ToggleJump(state)
    States.jumpEnabled = state
    local hum = getHumanoid()

    if state then
        originalJump = originalJump or getJump(hum)
        setJump(hum, originalJump * 2)
    else
        if originalJump then
            setJump(hum, originalJump)
            originalJump = nil
        end
    end
end


--Noclip
local noclipConn

local function setNoclip(state)
    for _, v in ipairs(getChar():GetDescendants()) do
        if v:IsA("BasePart") then
            v.CanCollide = not state
        end
    end
end

function ExploitsLogic.ToggleNoclip(state)
    States.noclipEnabled = state

    if state then
        noclipConn = RunService.Stepped:Connect(function()
            setNoclip(true)
        end)
    else
        if noclipConn then
            noclipConn:Disconnect()
            noclipConn = nil
        end
        setNoclip(false)
    end
end

--TouchFling
--local flingConn
--local function touchFling(state)

--AntiAfk
function ExploitsLogic.AntiAFK()
    if idleConn then return end

    idleConn = player.Idled:Connect(function()
        VirtualUser:Button2Down(Vector2.new(), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(), workspace.CurrentCamera.CFrame)
    end)
end

local idleConn

function ExploitsLogic.AntiAFK()
    if idleConn then return end
    idleConn = player.Idled:Connect(function()
        VirtualUser:Button2Down(Vector2.new(), workspace.CurrentCamera.CFrame)
        task.wait(1)
        VirtualUser:Button2Up(Vector2.new(), workspace.CurrentCamera.CFrame)
    end)
end

return ExploitsLogic